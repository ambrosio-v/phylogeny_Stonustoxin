---
title: "Script for poster trees"
author: "Ambrosio Rivera"
format: html
editor: visual
---

## UC LEADS symposium February 2025

Hopefully this is the last place I am writing code. Keep it clean

## Load libraries

Watch the warnings in case you need those objects later

```{r}
library(ape)
library(dplyr)
library(stringr)
library(phytools)
library(maps)

```

Check directory

```{r}
dir()
```

I moved all my files to the directory then submitted directory again to confirm

## Import data sets and assign names

```{r}
tree_coi_1 <- read.tree("COI_partial.fasta.treefile") # tree maximum likelyhood iqtree. This COI tree only has the species in the venom file
plot(tree_coi_1)
tree_sntx_1 <- read.tree("venom_w_gaps_2.fasta.treefile") # tree maximum likelyhood iqtree
plot(tree_sntx_1)

```

## Load labels

Apparently I gotta use the original FASTA files, which I was hesitant to do because I kept getting warnings that they were very big

```{r}
#label_coi_1 <- read.FASTA("COI_partial.fasta.log") # This COI tree noly has the species in the venom file
# returned nul, next view the first 6 rows of the fasta to see what they have
#View("COI_partial.fasta.log") its not a vector 
label_sntx_1 <- read.FASTA("venom_w_gaps_2.fasta")
label_coi_1 <- read.FASTA("COI_partial.fasta") # This COI tree noly has the species in the venom file

```

Check the labels

```{r}
head(label_coi_1)
head(label_sntx_1)
```

## Now to change tips

However I only need to change the COI tips

```{r}
fasta_obj.coi <- read.FASTA("COI_partial.fasta") # Im not really sure how this step is differnt but I've done a lot of over writing because I didn't want to make an new name for a data frame I'm gonna manipulate so Im just gonna do it
head(fasta_obj.coi)


```

Extract the names

```{r}
fasta_desc.coi <- names(fasta_obj.coi)
head(fasta_desc.coi)
```

Make a tibble that extracts the genus and species then pastes them together

```{r}
mapping_df.coi <- data.frame(
  full_label = fasta_desc.coi) %>% 
  mutate(
    accession = word(full_label, 1),
    genus = word(full_label,2),
    species = word(full_label, 3),
    genus_species = paste(genus,species)
)

```

```{r}
# check data frame 
head(mapping_df.coi) # its empty 
```

## confirm structure

```{r}
str(mapping_df.coi)
```

## check tree tips

```{r}
head(tree_coi_1$tip.label)
```

## remove \_1 so the tip.label matches the accession \# not sure though becuase both files have the \_1

```{r}
mapping_df.coi$accession <- str_remove(mapping_df.coi$accession, "_.*$")
```

## Replace tip labels

```{r}
tree_coi_1$tip.label <- mapping_df.coi$genus_species[
  match(tree_coi_1$tip.label, mapping_df.coi$accession)
]
```

## check tree

```{r}
plot(tree_coi_1)
```

## conclusion

it worked, but now I need to add the other species that are in the venom file. The outgroup is so different its causing scrunching. so I need to midpoint the tree

```{r}
library(phangorn)
tree_COI_midpoint <- midpoint.root(tree_coi_1)
plot(tree_COI_midpoint)

```

I don't like it

## Change the out group

check the tip labels

```{r}
tree_coi_1$tip.label
```

okay i'm seeing a problem the NA is probably Acanthopargus, i'ma try to root it there and then change the name

```{r}
library(phylotools)
tree_coi_1_sebum <- root.phylo(phy = tree_coi_1,
                          outgroup = "Sebastes umbrosus",
                            resolve.root = TRUE)
par(mar = c(1, 1, 1, 1))

plot(tree_coi_1_sebum,
     edge.width = 2,
     cex = 0.5,
     no.margin = TRUE)



tree_coi_1_sebum_lad <- ladderize(tree_coi_1_sebum)

par(mar = c(1, 1, 1, 1))
    
plot(tree_coi_1_sebum_lad,
     edge.width = 2,
     cex = 0.5,
     no.margin = TRUE)


```

Remove a branch

tree_coi_2 is gonna be same as tree coi 1 but with a species removed

view tip labels

```{r}
tree_coi_1$tip.label
# check other columns
str(tree_coi_1)
tree_coi_1$edge.length
tree_coi_1$Nnode
```

```{r}
tree_coi_2 <- drop.tip(tree_coi_1, "NA")
plot(tree_pruned)
```

# FIX up sntx tree

The problem with the COI partial tree might have to do with that there are so few, I am going to try to load the full tree rename thoes tips and make it print ready. The problem with the partial is that one of the branches is so distantly related that its scrunching the rest of the graph

```{r}
plot(tree_sntx_1)
```

view tip labels

```{r}
tree_sntx_1$tip.label
```

## Clean up tip labels

remove the number and the reversed

capitalize the genus and italicize everything

label_sntx_1_clean is going to be this cleaned up version

```{r}
label_sntx_1_clean <- data.frame(original = tree_sntx_1$tip.label) %>%
  mutate(
    # remove _reversed_ and any variation of it
    cleaned = str_remove(original, "_+reversed_?$"),
    
    # remove trailing underscore + number
    cleaned = str_remove(cleaned, "_\\d+$"),
    
    # replace underscores with spaces
    cleaned = str_replace_all(cleaned, "_", " "),
    
    # fix capitalization: Genus species
    cleaned = str_to_lower(cleaned),
    cleaned = str_to_sentence(cleaned)
  )
# Check
str(label_sntx_1_clean)
```

No way, I cant believe it worked on the first try

label_sntx_2_ital is going to be italiziced

creates an italic column

I couldn't make it italicized here is some code I played with

label_sntx_1_clean\$cleaned \# this vector exists and it has what I'm referring to

label_sntx_2_ital \<-data.frame( cleaned = label_sntx_1_clean\$cleaned) %\>% \# make a new tibble? and mutate the vector "cleaned" to italiciced mutate( cleaned = word(cleaned, "") )\
label_sntx_1_ital \<- label_sntx_1_clean %\>% mutate( italic_label = paste0(italic('", cleaned, "'))

```{r}
  # this tree is still good
plot(tree_sntx_1)
# remove the number and the reversed using this str(label_sntx_1_clean)
# I think I can use the code from before with accession to genus species trying it in next chunck

```

check

str(label_sntx_1_ital) no longer using label_sntx_1_ital

```{r}
clean_names <- names(label_sntx_1_ital)
# check
head(clean_names)
mapping_df_clean <- data.frame(
cleaned = clean_names
) 
head(mapping_df_clean)
# the observations are 123 and the column cleaned is original, cleaned italic_label I might need to rotate it and I don't have time tofigure that out


#setdiff(coi_pterois$tip.label, mapping_df$accession)
#coi_pterois$tip.label <- mapping_df$genus_species[
#match(coi_pterois$tip.label, mapping_df$accession)
#]

```

Replace Tree Tip Label

```{r}
tree_sntx_1$tip.label <- label_sntx_1_ital$italic_label


plot(tree_sntx_1, cex = 0.5)
```

This didn't work trying something else

trying to italicize with ggplot, using the original tree

```         
tree_sntx_3_ital <- data.frame(letter = c('a', 'b', 'c'), number = c(1, 2, 3)) kable(df2) %>%   kable_styling() %>%   column_spec(1, italic = TRUE) # Formats the first column as italic
```

```{r}
library(ggtree)

```

Be carefull rotate is now masked in ape remove ggtree later

# Going back to trying to export venom tree

```{r}
write.tree(tree_sntx_1, file ="tree_sntx_1.tree.file")
```

# Lets Goooooooooooooo!

## import COI complete and change tip labels move to tree.file

coi_A6 is going to be the tree from data processed today

```{r}
dir()
tree_coi_A6 <- read.tree("COI_complete.fasta.treefile")
# view tree
plot(tree_coi_A6)
# load fasta for names
label_coi_6A <- read.fasta("COI_complete.fasta")
head(label_coi_6A)
str(label_coi_6A) # check were good
```

# create a tibble with the correct names by extracting and mutating

```{r}
fasta_obj.coi6A <- read.FASTA("COI_complete_.fasta") # Im not really sure how this step is differnt but I've done a lot of over writing because I didn't want to make an new name for a data frame I'm gonna manipulate so Im just gonna do it
head(fasta_obj.coi6A)
```

next

```{r}
fasta_desc.coi6A <- names(fasta_obj.coi6A)
head(fasta_desc.coi6A)
```

```{r}
mapping_df.coi6A <- data.frame(
  full_label = fasta_desc.coi6A) %>% 
     mutate(
    accession = word(full_label, 1),
     genus = word(full_label,2),
     species = word(full_label, 3),
     genus_species = paste(genus,species)
 )
 # check data frame 
head(mapping_df.coi6A)
 
 
```

```{r}
mapping_df.coi6A$accession <- str_remove(mapping_df.coi6A$accession, "_.*$")
 View(mapping_df.coi6A)
tree_coi_A6$tip.label <- mapping_df.coi6A$genus_species[
  match(tree_coi_A6$tip.label, mapping_df.coi6A$accession)
 ]
plot(tree_coi_A6)
```

fasta_obj.coi \<- read.FASTA("COI_partial.fasta") \# Im not really sure how this step is differnt but I've done a lot of over writing because I didn't want to make an new name for a data frame I'm gonna manipulate so Im just gonna do it head(fasta_obj.coi)

# Make tree.file

```{r}
write.tree(tree_coi_A6, file ="tree_coi_A6.tree")
```

# Import tree file 

it didn't like that I have multiple of the same name

```{r}
# Collapse any single nodes in the tree
#single_collapsed_tree <- collapse.singles(tree_coi_A6)
#write.tree(tree_coi_A6, file ="single_collapsed_tree.tree")
```

This didn't work there are multiple of the same not together

# Import the tree file

```{r}

```

i think

```{r}
# Make duplicated labels unique by adding _1, _2, etc.
tree_coi_
$tip.label <- make.unique(tree_coi_C6$tip.label)

# Confirm no duplicates remain
any(duplicated(tree_coi_C6$tip.label))

# Write tree
write.tree(tree_coi_C6, file = "tree_coi_C6.tree")
```

# only keep one of each name

tips_to_keep \<- unique(tree_coi_A6$tip.label)
tips_to_drop <- setdiff(tree_coi_A6$tip.label, tips_to_keep) write.tree(tree_coi_A6, file ="tree_coi_A6_single.tree")

```{r}

```

look at labels

```{r}
tree_coi_A6$tip.label
```

print duplicates

```{r}
duplicated_labels <- tree_coi_A6$tip.label[duplicated(tree_coi_A6$tip.label)]
# To see which labels have duplicates
print(duplicated_labels)
```

# COI single copy

```{r}
dir()
tree_coi_C6 <- read.tree("COI_complete_singlecopy.fasta.treefile") # tree maximum likelyhood iqtree. This COI tree only has the species in the venom file
plot(tree_coi_C6)
label_coi_C6 <- read.FASTA("COI_complete_singlecopy.fasta")
str(label_coi_6A)
```

```{r}
fasta_obj.coi_C6 <- read.FASTA("COI_complete_singlecopy.fasta") # Im not really sure how this step is differnt but I've done a lot of over writing because I didn't want to make an new name for a data frame I'm gonna manipulate so Im just gonna do it
head(fasta_obj.coi_C6)
```

```{r}
fasta_names_C6 <- names(fasta_obj.coi_C6)
head(fasta_names_C6)
```

```{r}
mapping_df.coi_C6 <- data.frame(
  full_label = fasta_names_C6) %>% 
  mutate(
    accession = word(full_label, 1),
    genus = word(full_label,2),
    species = word(full_label, 3),
    genus_species = paste(genus,species)
)
```

```{r}
str(mapping_df.coi_C6)
```

```{r}
#head(tree_coi_1$tip.label)
```

```{r}
tree_coi_C6$tip.label <- mapping_df.coi_C6$genus_species[
  match(tree_coi_C6$tip.label, mapping_df.coi_C6$accession)
]
```

```{r}
mapping_df.coi$accession <- str_remove(mapping_df.coi$accession, "_.*$")
```

```{r}
plot(tree_coi_C6)
```

```{r}
write.tree(tree_coi_C6, file ="tree_coi_C6.tree")
```

```{r}
par(mar = c(1, 1, 1, 1))

plot(tree_coi_C6,
     edge.width = 2,
     cex = 0.5,
     no.margin = TRUE)
```

```{r}
write.tree(tree_coi_C6, file ="tree_coi_C6.tree")
```

```{r}
# Make duplicated labels unique by adding _1, _2, etc.
tree_coi_C6$tip.label <- make.unique(tree_coi_C6$tip.label)

# Confirm no duplicates remain
any(duplicated(tree_coi_C6$tip.label))

# Write tree
write.tree(tree_coi_C6, file = "tree_coi_C6.tree")
```

print

```{r}
pdf("C:/witteLab/phylogeny_Stonustoxin/UC_Leads/tree_coi_C6.pdf", width = 14, height = 14)
```

, width = 7, height = 7

```{r}

```

```{r}
tree_coi_C6$tip.label <- make.unique(tree_coi_C6$tip.label)
```

```{r}
write.tree(tree_coi_C6, file ="tree_coi_C6.tree")
```

```{r}
tree_coi_C6$tip.label <- ave(
  tree_coi_C6$tip.label,
  tree_coi_C6$tip.label,
  FUN = function(x) if(length(x) > 1)
    paste0(x, "_", seq_along(x))
  else x
)
```

```{r}
any(duplicated(tree_coi_C6$tip.label))
```

```{r}
tree_coi_C6 <- ladderize(tree_coi_C6)
tree_coi_C67 <- midpoint.root(tree_coi_C6)
plot(tree_coi_C67,
     edge.width = 2,
     cex = 0.4,
     no.margin = TRUE)
```

```{r}
pdf("C:/witteLab/phylogeny_Stonustoxin/UC_Leads/tree_coi_C67.pdf", width = 14, height = 14)
```

```{r}
write.tree(tree_coi_C67, file ="tree_coi_C67.tree.file")
```

# Complete_singlecopy

```{r}
tree_coi_D6 <- read.tree("COI_complete_singlecopy.treefile") # tree maximum likelyhood iqtree. This COI tree only has the species in the venom file
plot(tree_coi_D6)
```
